{% extends 'base.html' %}
{% load static %}

{% block title %}Devis {{ quote.number }} - Espace Client | Trait d'Union Studio{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/client-portal.css' %}">
{% endblock %}

{% block content %}
<div class="client-portal" x-data="{ sidebarOpen: true }">
    <!-- Mobile Toggle -->
    <button @click="sidebarOpen = !sidebarOpen" class="sidebar-toggle" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    {% include 'clients/partials/sidebar.html' %}

    <!-- Main Content -->
    <main class="client-main" :class="{ 'expanded': !sidebarOpen }">
        <header class="client-header">
            <div class="header-content">
                <div>
                    <nav class="breadcrumb">
                        <a href="{% url 'clients:dashboard' %}">Tableau de bord</a>
                        <span>/</span>
                        <a href="{% url 'clients:quotes' %}">Devis</a>
                        <span>/</span>
                        <span>{{ quote.number }}</span>
                    </nav>
                    <h1>Devis {{ quote.number }}</h1>
                </div>
                <div>
                    <a href="{% url 'clients:quote_pdf_download' quote.id %}" class="btn-client-primary" download>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Télécharger PDF
                    </a>
                </div>
            </div>
        </header>

        <div class="client-content">
            <!-- Info Bar -->
            <div class="detail-info-bar">
                <div class="info-item">
                    <span class="info-label">Statut</span>
                    <span class="status-badge status-{{ quote.status }}">{{ quote.get_status_display }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date d'émission</span>
                    <strong class="info-value">{{ quote.issue_date|date:"d/m/Y" }}</strong>
                </div>
                <div class="info-item">
                    <span class="info-label">Montant TTC</span>
                    <strong class="info-value info-amount">{{ quote.total_ttc|floatformat:2 }} €</strong>
                </div>
            </div>

            <!-- Quote Details Card -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Détails du devis
                    </h2>
                </div>
                <div class="detail-card-body">
                    <div class="parties-grid">
                        <!-- Émetteur -->
                        <div class="party-block">
                            <h3 class="party-label">Émetteur</h3>
                            <p class="party-name">Trait d'Union Studio</p>
                            <p class="party-info">
                                258 Av Justin Catayée<br>
                                Rte de la Madeleine<br>
                                97300 Cayenne, Guyane<br>
                                <a href="tel:+594695358041" class="party-link">+594 695 35 80 41</a><br>
                                <a href="#" class="tus-email-link party-link" data-email="Y29udGFjdEB0cmFpdGR1bmlvbi5pdA==" data-label="Nous écrire" aria-label="Envoyer un email à Trait d'Union Studio" rel="nofollow">Nous écrire</a>
                            </p>
                        </div>

                        <!-- Client -->
                        <div class="party-block">
                            <h3 class="party-label">Destinataire</h3>
                            <p class="party-name">
                                {% if quote.client.company %}{{ quote.client.company }}{% else %}{{ quote.client.full_name }}{% endif %}
                            </p>
                            <p class="party-info">
                                {% if quote.client.company and quote.client.full_name %}{{ quote.client.full_name }}<br>{% endif %}
                                {% if quote.client.address_line %}{{ quote.client.address_line }}<br>{% endif %}
                                {% if quote.client.zip_code or quote.client.city %}{{ quote.client.zip_code }} {{ quote.client.city }}<br>{% endif %}
                                <a href="mailto:{{ quote.client.email }}" class="party-link">{{ quote.client.email }}</a>
                                {% if quote.client.phone %}<br>{{ quote.client.phone }}{% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Items Table -->
                    {% if quote.quote_items.all %}
                    <div class="detail-table-wrap">
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Description</th>
                                    <th class="text-center" style="width: 80px;">Qté</th>
                                    <th class="text-right" style="width: 140px;">Prix unit.</th>
                                    <th class="text-right" style="width: 90px;">TVA</th>
                                    <th class="text-right" style="width: 140px;">Total TTC</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in quote.quote_items.all %}
                                <tr>
                                    <td>
                                        <strong>{{ item.description }}</strong>
                                        {% if item.detail %}<br><small class="text-muted">{{ item.detail }}</small>{% endif %}
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-right">{{ item.unit_price|floatformat:2 }} €</td>
                                    <td class="text-right">{{ item.vat_rate|default:"20"|floatformat:0 }}%</td>
                                    <td class="text-right text-accent">{{ item.total_ttc|floatformat:2 }} €</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Totals -->
                    <div class="totals-wrap">
                        <div class="totals-box">
                            <div class="total-row">
                                <span>Total HT</span>
                                <strong>{{ quote.total_ht|floatformat:2 }} €</strong>
                            </div>
                            <div class="total-row">
                                <span>TVA (20%)</span>
                                <strong>{{ quote.tva|floatformat:2 }} €</strong>
                            </div>
                            <div class="total-row total-final">
                                <span>Total TTC</span>
                                <strong>{{ quote.total_ttc|floatformat:2 }} €</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    {% if quote.notes %}
                    <div class="detail-notes">
                        <h3>Notes</h3>
                        <p>{{ quote.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Aperçu PDF -->
            <div class="detail-card" style="margin-top: 1.5rem;">
                <div class="detail-card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Aperçu du PDF
                    </h2>
                </div>
                <div class="detail-card-body">
                    <div class="pdf-preview">
                        <embed src="{% url 'clients:quote_pdf_view' quote.id %}" type="application/pdf" width="100%" height="100%" />
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
/* ========================================
   QUOTE DETAIL - DARK PREMIUM THEME
   Cohérent avec le portail client TUS
   ======================================== */
.client-sidebar.collapsed { width: var(--sidebar-collapsed); }

.sidebar-toggle {
    display: none;
    position: fixed;
    top: 90px;
    left: 10px;
    z-index: 50;
    width: 44px;
    height: 44px;
    background: var(--client-surface);
    border: 1px solid var(--client-border);
    border-radius: 10px;
    color: var(--client-text);
    cursor: pointer;
    align-items: center;
    justify-content: center;
}

.sidebar-header:hover .collapse-btn svg { transition: transform 0.3s ease; }
.client-main.expanded { margin-left: var(--sidebar-collapsed); max-width: calc(100vw - var(--sidebar-collapsed)); }

.breadcrumb a:hover { text-decoration: underline; }
/* Info Bar */
.detail-card-header h2 svg { stroke: var(--client-blue); }

/* Parties Grid */
.party-link:hover { text-decoration: underline; }

/* Table */
.detail-table thead tr { border-bottom: 2px solid var(--client-border); }

.detail-table tbody tr { border-bottom: 1px solid var(--client-border); transition: background 0.2s; }
.detail-table tbody tr:hover { background: var(--client-surface-hover); }

.detail-table td small.text-muted { color: var(--client-text-muted); }

/* Totals */
.total-row:last-child { border-bottom: none; }
.total-row span { color: var(--client-text-muted); font-size: 0.9rem; }
.total-row strong { color: var(--client-text); }

.total-final span { font-size: 1rem; font-weight: 600; color: var(--client-text); }
.total-final strong { font-size: 1.25rem; color: var(--client-blue); }

/* Notes */
/* PDF Preview */
.pdf-preview embed,
.pdf-preview iframe,
.pdf-preview object {
    width: 100% !important;
    height: 100% !important;
    border: 0 !important;
}

@media (max-width: 768px) {
    .sidebar-toggle { display: flex; }
    }
</style>
{% endblock %}
