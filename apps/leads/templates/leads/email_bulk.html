{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Envoi en masse | Trait d'Union Studio{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
<style>
    .bulk-form { max-width: 1000px; margin: 0 auto; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .form-control { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        font-size: 14px;
        transition: border-color 0.2s;
    }
    .form-control:focus { border-color: #0B2DFF; outline: none; box-shadow: 0 0 0 3px rgba(11, 45, 255, 0.1); }
    textarea.form-control { min-height: 150px; font-family: monospace; }
    .btn-send { 
        background: linear-gradient(135deg, #0B2DFF 0%, #6366f1 100%);
        color: white; 
        padding: 14px 32px; 
        border: none; 
        border-radius: 8px; 
        font-size: 16px; 
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-send:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(11, 45, 255, 0.3); }
    .btn-send:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .email-counter { 
        background: #f8f9fa; 
        padding: 12px 16px; 
        border-radius: 8px; 
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .email-counter .count { 
        font-size: 24px; 
        font-weight: 700; 
        color: #0B2DFF; 
    }
    .help-text { font-size: 13px; color: #666; margin-top: 6px; }
    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }
    .warning-box h4 { margin: 0 0 8px 0; color: #856404; }
    .warning-box ul { margin: 0; padding-left: 20px; color: #856404; }
    .template-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .template-card {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .template-card:hover { border-color: #0B2DFF; background: #f8f9ff; }
    .template-card.selected { border-color: #0B2DFF; background: #eff1ff; }
    .template-card h5 { margin: 0 0 4px 0; font-size: 14px; }
    .template-card span { font-size: 12px; color: #666; }
    .delay-input { width: 80px; display: inline-block; }
    .progress-bar {
        display: none;
        background: #e5e7eb;
        border-radius: 8px;
        height: 8px;
        margin-top: 20px;
        overflow: hidden;
    }
    .progress-bar .progress {
        background: linear-gradient(90deg, #0B2DFF, #6366f1);
        height: 100%;
        width: 0%;
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="bulk-form">
    <h1 style="margin-bottom: 10px;">üìß Envoi en masse</h1>
    <p style="color: #666; margin-bottom: 30px;">
        Envoyez le m√™me email √† plusieurs destinataires. Chaque personne recevra un email <strong>individuel</strong> 
        (pas de CC/BCC visible).
    </p>
    
    <div class="warning-box">
        <h4>‚ö†Ô∏è Bonnes pratiques anti-spam</h4>
        <ul>
            <li>Limitez √† <strong>50-100 emails/heure</strong> pour √©viter les blocages</li>
            <li>Utilisez un <strong>d√©lai entre chaque envoi</strong> (1-2 secondes recommand√©)</li>
            <li>√âvitez les mots spam : "GRATUIT", "URGENT", "OFFRE EXCEPTIONNELLE"</li>
            <li>Assurez-vous que les destinataires ont un lien avec votre activit√©</li>
        </ul>
    </div>

    <form method="post" id="bulkEmailForm">
        {% csrf_token %}
        
        <!-- Liste des emails -->
        <div class="form-group">
            <label for="emails">üì¨ Adresses email des destinataires</label>
            <textarea 
                name="emails" 
                id="emails" 
                class="form-control" 
                placeholder="email1@exemple.com
email2@exemple.com
email3@exemple.com

Ou s√©par√©s par des virgules : email1@ex.com, email2@ex.com"
                required
            ></textarea>
            <p class="help-text">Un email par ligne, ou s√©par√©s par des virgules/points-virgules. Les doublons seront automatiquement supprim√©s.</p>
            <div class="email-counter">
                <span class="count" id="emailCount">0</span>
                <span>adresse(s) email d√©tect√©e(s)</span>
            </div>
        </div>
        
        <!-- S√©lection de template -->
        <div class="form-group">
            <label>üìã Choisir un template (optionnel)</label>
            <div class="template-selector">
                <div class="template-card" data-template="none" onclick="selectTemplate(null)">
                    <h5>‚úèÔ∏è Email personnalis√©</h5>
                    <span>R√©diger manuellement</span>
                </div>
                {% for template in templates %}
                <div class="template-card" data-template="{{ template.id }}" onclick="selectTemplate({{ template.id }})">
                    <h5>{{ template.name }}</h5>
                    <span>{{ template.get_category_display }}</span>
                </div>
                {% endfor %}
            </div>
            <input type="hidden" name="template" id="templateId" value="">
        </div>
        
        <!-- Sujet -->
        <div class="form-group">
            <label for="subject">üìù Sujet de l'email</label>
            <input 
                type="text" 
                name="subject" 
                id="subject" 
                class="form-control" 
                placeholder="Ex: Accompagnement digital sur-mesure ‚Äì Trait d'Union Studio"
                required
            >
        </div>
        
        <!-- Contenu -->
        <div class="form-group">
            <label for="body_html">‚úçÔ∏è Contenu de l'email</label>
            <textarea name="body_html" id="body_html" class="form-control"></textarea>
        </div>
        
        <!-- Options -->
        <div class="form-group">
            <label>‚öôÔ∏è Options d'envoi</label>
            <p>
                D√©lai entre chaque email : 
                <input type="number" name="delay" value="1" min="0" max="10" step="0.5" class="form-control delay-input"> 
                seconde(s)
            </p>
            <p class="help-text">Un d√©lai de 1-2 secondes est recommand√© pour √©viter les limites de taux de Brevo.</p>
        </div>
        
        <!-- Submit -->
        <div class="form-group" style="margin-top: 30px;">
            <button type="submit" class="btn-send" id="submitBtn">
                üöÄ Envoyer √† <span id="sendCount">0</span> destinataire(s)
            </button>
        </div>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress" id="progress"></div>
        </div>
    </form>
</div>

<script>
    // Initialiser TinyMCE
    tinymce.init({
        selector: '#body_html',
        height: 400,
        menubar: false,
        plugins: 'lists link image code paste',
        toolbar: 'undo redo | formatselect | bold italic underline | bullist numlist | link | code',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px; line-height: 1.6; }',
        paste_as_text: true,
    });
    
    // Compter les emails
    const emailsTextarea = document.getElementById('emails');
    const emailCount = document.getElementById('emailCount');
    const sendCount = document.getElementById('sendCount');
    
    function countEmails() {
        const text = emailsTextarea.value;
        const emails = text
            .replace(/,/g, '\n')
            .replace(/;/g, '\n')
            .split('\n')
            .map(e => e.trim())
            .filter(e => e && e.includes('@'));
        
        // Supprimer les doublons
        const unique = [...new Set(emails)];
        emailCount.textContent = unique.length;
        sendCount.textContent = unique.length;
    }
    
    emailsTextarea.addEventListener('input', countEmails);
    
    // S√©lection de template
    function selectTemplate(templateId) {
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        if (templateId) {
            document.querySelector(`[data-template="${templateId}"]`).classList.add('selected');
            document.getElementById('templateId').value = templateId;
            
            // Charger le template via AJAX
            fetch(`/tus-gestion-secure/emails/api/templates/${templateId}/`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('subject').value = data.subject;
                        tinymce.get('body_html').setContent(data.body_html);
                    }
                });
        } else {
            document.querySelector('[data-template="none"]').classList.add('selected');
            document.getElementById('templateId').value = '';
        }
    }
    
    // Confirmation avant envoi
    document.getElementById('bulkEmailForm').addEventListener('submit', function(e) {
        const count = parseInt(emailCount.textContent);
        if (count === 0) {
            e.preventDefault();
            alert('Veuillez entrer au moins une adresse email valide.');
            return;
        }
        
        if (!confirm(`√ätes-vous s√ªr de vouloir envoyer cet email √† ${count} destinataire(s) ?\n\nCette action est irr√©versible.`)) {
            e.preventDefault();
            return;
        }
        
        // D√©sactiver le bouton et afficher la progression
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = '‚è≥ Envoi en cours...';
    });
</script>
{% endblock %}
