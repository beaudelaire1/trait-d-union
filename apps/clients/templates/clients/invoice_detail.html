{% extends 'base.html' %}
{% load static %}

{% block title %}Facture {{ invoice.number }} - Espace Client | Trait d'Union Studio{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/client-portal.css' %}">
{% endblock %}

{% block content %}
<div class="client-portal" x-data="{ sidebarOpen: true }">
    <!-- Mobile Toggle -->
    <button @click="sidebarOpen = !sidebarOpen" class="sidebar-toggle" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    {% include 'clients/partials/sidebar.html' %}

    <!-- Main Content -->
    <main class="client-main" :class="{ 'expanded': !sidebarOpen }">
        <header class="client-header">
            <div class="header-content">
                <div>
                    <nav class="breadcrumb">
                        <a href="{% url 'clients:dashboard' %}">Tableau de bord</a>
                        <span>/</span>
                        <a href="{% url 'clients:invoices' %}">Factures</a>
                        <span>/</span>
                        <span>{{ invoice.number }}</span>
                    </nav>
                    <h1>Facture {{ invoice.number }}</h1>
                </div>
                <div>
                    <a href="{% url 'clients:invoice_pdf_download' invoice.id %}" class="btn-client-primary" download>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Télécharger PDF
                    </a>
                </div>
            </div>
        </header>

        <div class="client-content">
            <!-- Info Bar -->
            <div class="detail-info-bar">
                <div class="info-item">
                    <span class="info-label">Statut</span>
                    <span class="status-badge status-{{ invoice.status }}">{{ invoice.get_status_display }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date d'émission</span>
                    <strong class="info-value">{{ invoice.issue_date|date:"d/m/Y" }}</strong>
                </div>
                {% if invoice.due_date %}
                <div class="info-item">
                    <span class="info-label">Date limite</span>
                    <strong class="info-value">{{ invoice.due_date|date:"d/m/Y" }}</strong>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">Montant TTC</span>
                    <strong class="info-value info-amount">{{ invoice.total_ttc|floatformat:2 }} €</strong>
                </div>
            </div>

            <!-- Invoice Details Card -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        Détails de la facture
                    </h2>
                </div>
                <div class="detail-card-body">
                    <div class="parties-grid">
                        <!-- Émetteur -->
                        <div class="party-block">
                            <h3 class="party-label">Émetteur</h3>
                            <p class="party-name">Trait d'Union Studio</p>
                            <p class="party-info">
                                258 Av Justin Catayée<br>
                                Rte de la Madeleine<br>
                                97300 Cayenne, Guyane<br>
                                <a href="tel:+594695358041" class="party-link">+594 695 35 80 41</a><br>
                                <a href="#" class="tus-email-link party-link" data-email="Y29udGFjdEB0cmFpdGR1bmlvbi5pdA==" data-label="Nous écrire" aria-label="Envoyer un email à Trait d'Union Studio" rel="nofollow">Nous écrire</a><br>
                                <strong>SIRET:</strong> 908 264 112 00016
                            </p>
                        </div>

                        <!-- Client -->
                        <div class="party-block">
                            <h3 class="party-label">Destinataire</h3>
                            <p class="party-name">
                                {% if invoice.quote.client.company %}{{ invoice.quote.client.company }}{% else %}{{ invoice.quote.client.full_name }}{% endif %}
                            </p>
                            <p class="party-info">
                                {% if invoice.quote.client.company and invoice.quote.client.full_name %}{{ invoice.quote.client.full_name }}<br>{% endif %}
                                {% if invoice.quote.client.address_line %}{{ invoice.quote.client.address_line }}<br>{% endif %}
                                {% if invoice.quote.client.zip_code or invoice.quote.client.city %}{{ invoice.quote.client.zip_code }} {{ invoice.quote.client.city }}<br>{% endif %}
                                <a href="mailto:{{ invoice.quote.client.email }}" class="party-link">{{ invoice.quote.client.email }}</a>
                                {% if invoice.quote.client.phone %}<br>{{ invoice.quote.client.phone }}{% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Items Table -->
                    {% if invoice.invoice_items.all %}
                    <div class="detail-table-wrap">
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Description</th>
                                    <th class="text-center" style="width: 80px;">Qté</th>
                                    <th class="text-right" style="width: 140px;">Prix unit.</th>
                                    <th class="text-right" style="width: 90px;">TVA</th>
                                    <th class="text-right" style="width: 140px;">Total TTC</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in invoice.invoice_items.all %}
                                <tr>
                                    <td>
                                        <strong>{{ item.description }}</strong>
                                        {% if item.detail %}<br><small class="text-muted">{{ item.detail }}</small>{% endif %}
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-right">{{ item.unit_price|floatformat:2 }} €</td>
                                    <td class="text-right">{{ item.vat_rate|default:"20"|floatformat:0 }}%</td>
                                    <td class="text-right text-accent">{{ item.total_ttc|floatformat:2 }} €</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Totals -->
                    <div class="totals-wrap">
                        <div class="totals-box">
                            <div class="total-row">
                                <span>Total HT</span>
                                <strong>{{ invoice.total_ht|floatformat:2 }} €</strong>
                            </div>
                            <div class="total-row">
                                <span>TVA (20%)</span>
                                <strong>{{ invoice.tva|floatformat:2 }} €</strong>
                            </div>
                            {% if invoice.discount %}
                            <div class="total-row">
                                <span>Remise</span>
                                <strong>-{{ invoice.discount|floatformat:2 }} €</strong>
                            </div>
                            {% endif %}
                            <div class="total-row total-final">
                                <span>Total TTC</span>
                                <strong>{{ invoice.total_ttc|floatformat:2 }} €</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Status -->
                    {% if invoice.status == 'paid' %}
                    <div class="payment-status payment-success">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <p>Facture payée le {{ invoice.paid_at|date:"d/m/Y" }}</p>
                    </div>
                    {% elif invoice.status == 'sent' or invoice.status == 'overdue' %}
                    <div class="payment-status payment-pending">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div>
                            <p>En attente de paiement</p>
                            <a href="#">Payer la facture</a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Notes -->
                    {% if invoice.notes %}
                    <div class="detail-notes">
                        <h3>Notes</h3>
                        <p>{{ invoice.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
</div>

<style>
/* ========================================
   INVOICE DETAIL - DARK PREMIUM THEME
   Cohérent avec le portail client TUS
   ======================================== */
.client-sidebar.collapsed { width: var(--sidebar-collapsed); }

.sidebar-toggle {
    display: none;
    position: fixed;
    top: 90px;
    left: 10px;
    z-index: 50;
    width: 44px;
    height: 44px;
    background: var(--client-surface);
    border: 1px solid var(--client-border);
    border-radius: 10px;
    color: var(--client-text);
    cursor: pointer;
    align-items: center;
    justify-content: center;
}

.sidebar-header:hover .collapse-btn svg { transition: transform 0.3s ease; }
.client-main.expanded { margin-left: var(--sidebar-collapsed); max-width: calc(100vw - var(--sidebar-collapsed)); }

.breadcrumb a:hover { text-decoration: underline; }
/* Info Bar */
.detail-card-header h2 svg { stroke: var(--client-blue); }

/* Parties Grid */
.party-link:hover { text-decoration: underline; }

/* Table */
.detail-table thead tr { border-bottom: 2px solid var(--client-border); }

.detail-table tbody tr { border-bottom: 1px solid var(--client-border); transition: background 0.2s; }
.detail-table tbody tr:hover { background: var(--client-surface-hover); }

.detail-table td small.text-muted { color: var(--client-text-muted); }

/* Totals */
.total-row:last-child { border-bottom: none; }
.total-row span { color: var(--client-text-muted); font-size: 0.9rem; }
.total-row strong { color: var(--client-text); }

.total-final span { font-size: 1rem; font-weight: 600; color: var(--client-text); }
.total-final strong { font-size: 1.25rem; color: var(--client-blue); }

/* Payment Status */
.payment-pending a { color: var(--client-orange); text-decoration: underline; font-size: 0.9rem; }
.payment-pending a:hover { opacity: 0.8; }

/* Notes */
@media (max-width: 768px) {
    .sidebar-toggle { display: flex; }
    }
</style>
{% endblock %}
