{% extends 'base.html' %}
{% load static %}

{% block title %}Devis {{ quote.number }} - Espace Client | Trait d'Union Studio{% endblock %}

{% block content %}
<div class="client-portal" x-data="{ sidebarOpen: true }">
    <!-- Mobile Toggle -->
    <button @click="sidebarOpen = !sidebarOpen" class="sidebar-toggle" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    {% include 'clients/partials/sidebar.html' %}

    <!-- Main Content -->
    <main class="client-main" :class="{ 'expanded': !sidebarOpen }">
        <header class="client-header">
            <div class="header-content">
                <div>
                    <nav class="breadcrumb">
                        <a href="{% url 'clients:dashboard' %}">Tableau de bord</a>
                        <span>/</span>
                        <a href="{% url 'clients:quotes' %}">Devis</a>
                        <span>/</span>
                        <span>{{ quote.number }}</span>
                    </nav>
                    <h1>Devis {{ quote.number }}</h1>
                </div>
                <div>
                    <a href="{% url 'clients:quote_pdf_download' quote.id %}" class="btn-client-primary" download>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Télécharger PDF
                    </a>
                </div>
            </div>
        </header>

        <div class="client-content">
            <!-- Info Bar -->
            <div class="detail-info-bar">
                <div class="info-item">
                    <span class="info-label">Statut</span>
                    <span class="status-badge status-{{ quote.status }}">{{ quote.get_status_display }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date d'émission</span>
                    <strong class="info-value">{{ quote.issue_date|date:"d/m/Y" }}</strong>
                </div>
                <div class="info-item">
                    <span class="info-label">Montant TTC</span>
                    <strong class="info-value info-amount">{{ quote.total_ttc|floatformat:2 }} €</strong>
                </div>
            </div>

            <!-- Quote Details Card -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Détails du devis
                    </h2>
                </div>
                <div class="detail-card-body">
                    <div class="parties-grid">
                        <!-- Émetteur -->
                        <div class="party-block">
                            <h3 class="party-label">Émetteur</h3>
                            <p class="party-name">Trait d'Union Studio</p>
                            <p class="party-info">
                                258 Av Justin Catayée<br>
                                Rte de la Madeleine<br>
                                97300 Cayenne, Guyane<br>
                                <a href="tel:+594695358041" class="party-link">+594 695 35 80 41</a><br>
                                <a href="#" class="tus-email-link party-link" data-email="Y29udGFjdEB0cmFpdGR1bmlvbi5pdA==" data-label="Nous écrire" aria-label="Envoyer un email à Trait d'Union Studio" rel="nofollow">Nous écrire</a>
                            </p>
                        </div>

                        <!-- Client -->
                        <div class="party-block">
                            <h3 class="party-label">Destinataire</h3>
                            <p class="party-name">
                                {% if quote.client.company %}{{ quote.client.company }}{% else %}{{ quote.client.full_name }}{% endif %}
                            </p>
                            <p class="party-info">
                                {% if quote.client.company and quote.client.full_name %}{{ quote.client.full_name }}<br>{% endif %}
                                {% if quote.client.address_line %}{{ quote.client.address_line }}<br>{% endif %}
                                {% if quote.client.zip_code or quote.client.city %}{{ quote.client.zip_code }} {{ quote.client.city }}<br>{% endif %}
                                <a href="mailto:{{ quote.client.email }}" class="party-link">{{ quote.client.email }}</a>
                                {% if quote.client.phone %}<br>{{ quote.client.phone }}{% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Items Table -->
                    {% if quote.quote_items.all %}
                    <div class="detail-table-wrap">
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Description</th>
                                    <th class="text-center" style="width: 80px;">Qté</th>
                                    <th class="text-right" style="width: 140px;">Prix unit.</th>
                                    <th class="text-right" style="width: 90px;">TVA</th>
                                    <th class="text-right" style="width: 140px;">Total TTC</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in quote.quote_items.all %}
                                <tr>
                                    <td>
                                        <strong>{{ item.description }}</strong>
                                        {% if item.detail %}<br><small class="text-muted">{{ item.detail }}</small>{% endif %}
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-right">{{ item.unit_price|floatformat:2 }} €</td>
                                    <td class="text-right">{{ item.vat_rate|default:"20"|floatformat:0 }}%</td>
                                    <td class="text-right text-accent">{{ item.total_ttc|floatformat:2 }} €</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Totals -->
                    <div class="totals-wrap">
                        <div class="totals-box">
                            <div class="total-row">
                                <span>Total HT</span>
                                <strong>{{ quote.total_ht|floatformat:2 }} €</strong>
                            </div>
                            <div class="total-row">
                                <span>TVA (20%)</span>
                                <strong>{{ quote.tva|floatformat:2 }} €</strong>
                            </div>
                            <div class="total-row total-final">
                                <span>Total TTC</span>
                                <strong>{{ quote.total_ttc|floatformat:2 }} €</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    {% if quote.notes %}
                    <div class="detail-notes">
                        <h3>Notes</h3>
                        <p>{{ quote.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Aperçu PDF -->
            <div class="detail-card" style="margin-top: 1.5rem;">
                <div class="detail-card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Aperçu du PDF
                    </h2>
                </div>
                <div class="detail-card-body">
                    <div class="pdf-preview">
                        <embed src="{% url 'clients:quote_pdf_view' quote.id %}" type="application/pdf" width="100%" height="100%" />
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
/* ========================================
   QUOTE DETAIL - DARK PREMIUM THEME
   Cohérent avec le portail client TUS
   ======================================== */
:root {
    --client-bg: #0a0a0f;
    --client-surface: #12121a;
    --client-surface-hover: #1a1a25;
    --client-border: rgba(255,255,255,0.08);
    --client-text: #f6f7fb;
    --client-text-muted: rgba(246,247,251,0.6);
    --client-blue: #0B2DFF;
    --client-blue-soft: rgba(11,45,255,0.15);
    --client-green: #10B981;
    --client-red: #EF4444;
    --sidebar-width: 280px;
    --sidebar-collapsed: 80px;
}

.client-portal {
    min-height: 100vh;
    background: var(--client-bg);
    display: flex;
    padding-top: 80px;
}

/* Sidebar */
.client-sidebar {
    width: var(--sidebar-width);
    background: var(--client-surface);
    border-right: 1px solid var(--client-border);
    padding: 1.5rem 1rem;
    position: fixed;
    top: 80px;
    left: 0;
    bottom: 0;
    overflow-y: auto;
    z-index: 40;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.client-sidebar.collapsed { width: var(--sidebar-collapsed); }

.sidebar-toggle {
    display: none;
    position: fixed;
    top: 90px;
    left: 10px;
    z-index: 50;
    width: 44px;
    height: 44px;
    background: var(--client-surface);
    border: 1px solid var(--client-border);
    border-radius: 10px;
    color: var(--client-text);
    cursor: pointer;
    align-items: center;
    justify-content: center;
}

.sidebar-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--client-border);
    margin-bottom: 1.5rem;
    position: relative;
}

.collapse-btn {
    position: absolute;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    background: var(--client-surface);
    border: 1px solid var(--client-border);
    border-radius: 50%;
    color: var(--client-text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
}

.sidebar-header:hover .collapse-btn { opacity: 1; }
.collapse-btn:hover { background: var(--client-blue); border-color: var(--client-blue); color: white; }
.collapse-btn svg { transition: transform 0.3s ease; }
.collapse-btn svg.rotated { transform: rotate(180deg); }

.user-avatar {
    width: 48px;
    height: 48px;
    min-width: 48px;
    background: linear-gradient(135deg, var(--client-blue), #0922CC);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
}

.user-info h3 { font-size: 1rem; font-weight: 600; color: var(--client-text); margin-bottom: 0.25rem; }
.user-info p { font-size: 0.85rem; color: var(--client-text-muted); }

.sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; }

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border-radius: 10px;
    color: var(--client-text-muted);
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.nav-item:hover { background: var(--client-surface-hover); color: var(--client-text); }
.nav-item.active { background: var(--client-blue-soft); color: var(--client-blue); }
.nav-item.active svg { stroke: var(--client-blue); }
.nav-item.logout { color: var(--client-red); }
.nav-item.logout:hover { background: rgba(239,68,68,0.1); }

.nav-divider { height: 1px; background: var(--client-border); margin: 1rem 0; }

/* Main Content */
.client-main {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 2rem;
    max-width: calc(100vw - var(--sidebar-width));
    transition: margin-left 0.3s ease, max-width 0.3s ease;
}

.client-main.expanded { margin-left: var(--sidebar-collapsed); max-width: calc(100vw - var(--sidebar-collapsed)); }

.client-header { margin-bottom: 2rem; }

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.client-header h1 { font-size: 1.75rem; font-weight: 700; color: var(--client-text); }

.breadcrumb { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; margin-bottom: 0.5rem; }
.breadcrumb a { color: var(--client-blue); text-decoration: none; }
.breadcrumb a:hover { text-decoration: underline; }
.breadcrumb span { color: var(--client-text-muted); }

.btn-client-primary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--client-blue);
    color: white;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.95rem;
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-client-primary:hover {
    background: #0922cc;
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(11,45,255,0.4);
}

/* Info Bar */
.detail-info-bar {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 1.25rem 1.5rem;
    background: var(--client-surface);
    border: 1px solid var(--client-border);
    border-radius: 16px;
    flex-wrap: wrap;
}

.info-item { display: flex; flex-direction: column; gap: 0.5rem; }
.info-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--client-text-muted); font-weight: 600; }
.info-value { color: var(--client-text); font-weight: 600; }
.info-amount { font-size: 1.25rem; color: var(--client-blue); }

/* Status Badges - Dark Theme */
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-draft { background: rgba(107,114,128,0.2); color: #9CA3AF; }
.status-sent { background: rgba(59,130,246,0.2); color: #60A5FA; }
.status-accepted { background: rgba(16,185,129,0.2); color: #34D399; }
.status-rejected { background: rgba(239,68,68,0.2); color: #F87171; }
.status-invoiced { background: rgba(245,158,11,0.2); color: #FBBF24; }

/* Detail Card */
.detail-card {
    background: var(--client-surface);
    border: 1px solid var(--client-border);
    border-radius: 16px;
    overflow: hidden;
}

.detail-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--client-border);
}

.detail-card-header h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--client-text);
}

.detail-card-header h2 svg { stroke: var(--client-blue); }

.detail-card-body { padding: 1.5rem; }

/* Parties Grid */
.parties-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.party-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--client-text-muted);
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.party-name { font-size: 1rem; font-weight: 600; color: var(--client-text); margin-bottom: 0.5rem; }

.party-info { font-size: 0.875rem; color: var(--client-text-muted); line-height: 1.7; }

.party-link { color: var(--client-blue); text-decoration: none; }
.party-link:hover { text-decoration: underline; }

/* Table */
.detail-table-wrap { overflow-x: auto; margin: 1.5rem 0; }

.detail-table {
    width: 100%;
    border-collapse: collapse;
}

.detail-table thead tr { border-bottom: 2px solid var(--client-border); }

.detail-table th {
    padding: 0.875rem 1rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--client-text-muted);
    font-weight: 600;
}

.detail-table tbody tr { border-bottom: 1px solid var(--client-border); transition: background 0.2s; }
.detail-table tbody tr:hover { background: var(--client-surface-hover); }

.detail-table td { padding: 0.875rem 1rem; color: var(--client-text); font-size: 0.9rem; }
.detail-table td small.text-muted { color: var(--client-text-muted); }

.text-left { text-align: left; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-accent { color: var(--client-blue) !important; font-weight: 600; }

/* Totals */
.totals-wrap { display: flex; justify-content: flex-end; margin-top: 1.5rem; }

.totals-box {
    width: 300px;
    border: 1px solid var(--client-border);
    border-radius: 12px;
    padding: 1.25rem;
    background: var(--client-surface-hover);
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--client-border);
}

.total-row:last-child { border-bottom: none; }
.total-row span { color: var(--client-text-muted); font-size: 0.9rem; }
.total-row strong { color: var(--client-text); }

.total-final span { font-size: 1rem; font-weight: 600; color: var(--client-text); }
.total-final strong { font-size: 1.25rem; color: var(--client-blue); }

/* Notes */
.detail-notes {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--client-border);
}

.detail-notes h3 { font-size: 0.875rem; font-weight: 600; color: var(--client-text); margin-bottom: 0.75rem; }
.detail-notes p { color: var(--client-text-muted); white-space: pre-wrap; line-height: 1.6; }

/* PDF Preview */
.pdf-preview {
    height: 70vh;
    border: 1px solid var(--client-border);
    border-radius: 10px;
    overflow: hidden;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pdf-preview embed,
.pdf-preview iframe,
.pdf-preview object {
    width: 100% !important;
    height: 100% !important;
    border: 0 !important;
}

/* Responsive */
@media (max-width: 768px) {
    .client-sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
    .sidebar-toggle { display: flex; }
    .client-main { margin-left: 0; max-width: 100%; padding: 1rem; }
    .detail-info-bar { flex-direction: column; align-items: flex-start; }
    .parties-grid { grid-template-columns: 1fr; }
    .header-content { flex-direction: column; align-items: flex-start; }
    .detail-table-wrap { margin: 1rem -1rem; padding: 0 1rem; }
    .totals-box { width: 100%; }
    .totals-wrap { justify-content: stretch; }
}
</style>
{% endblock %}
